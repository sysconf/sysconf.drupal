# sysconf-etc.d â€“ for the ```conf.d``` pattern

## Splitting ```config``` into ```config.d/*.config```

The ```conf.d``` pattern, widely used on the *Debian GNU/Linux*
distribution among others, is about turning a configuration **file**
(like ```conf```) into a **directory** (like ```conf.d```) where the config lies into
multiple files.

Where the pattern is enabled, it is easy to have sysconf-managed
files, for example: ```/etc/nginx/sites-available/```,
```/etc/logrotate.d/```, etc.

But there are programs distributed with a unique config file:

* some allow include directives with wildcards: it is the case of
```/etc/network/interfaces``` to which we can add: ```source
/etc/network/interfaces.d/*.interfaces```;

* some allow include directives without wildcard: it is the case of
  ```/etc/gitconfig``` where included files need to be listed
  explicitely under the ```[include]``` section;

* some do not allow any includes anyway: it is the case of
  ```/etc/hosts``` which needs to be updated in place with the
  concatenation of ```/etc/hosts/*.hosts```.


Once the mecanism is enabled for a particular file (for example,
```/etc/hosts```), every Sysconf profile can take advantage of it by
providing its specific config (```/etc/hosts/profile-a.hosts``` for
example) in a clean and non-obstrusive way.

This is why Sysconf provides
[sysconf-etc.d](../tree/usr/bin/sysconf-etc.d), a generic tool that
fixes the required config files, which are by default:

* ```/etc/hosts``` out of ```/etc/hosts/*.hosts```
* ```/etc/ssh/ssh_config``` out of ```/etc/ssh/ssh_config.d/*.ssh_config```
* ```/etc/ssh/sshd_config``` out of ```/etc/ssh/sshd_config.d/*.sshd_config```
* ```/etc/gitconfig``` out of ```/etc/gitconfig.d/*.gitconfig```

Other files can be acted upon, when specified through a
```.meta.conf``` file in ```/etc/sysconf/etc.d```: see the example below.


## Example

Suppose you have 2 files:

**/etc/gitconfig.d/alias.gitconfig**:
```
[alias]
  st = status
  ci = commit
```

**/etc/gitconfig.d/colors.gitconfig**:
```
[color]
  ui = auto
[color "branch"]
  current = yellow reverse
  local = yellow
  remote = green
```

If you define the following *meta conf* that explains how
```/etc/gitconfig``` should be generated,

**/etc/sysconf/etc.d/gitconfig.meta.conf**:
```
SYSCONF_ETC_CONFIG_TARGET_CONF=/etc/gitconfig
SYSCONF_ETC_CONFIG_TYPE=reference
SYSCONF_ETC_CONFIG_BEGIN="[include]"
SYSCONF_ETC_CONFIG_EXPRESSION="  path = "
```

... then you can run [sysconf-etc.d](../../../usr/bin/sysconf-etc.d):
```
sysconf-etc.d update gitconfig
```

And it will generate this following **```/etc/gitconfig```**:
```
# GENERATED BY sysconf-etc.d

[include]
  path = /etc/gitconfig.d/colors.gitconfig
  path = /etc/gitconfig.d/alias.gitconfig
```


## Specification

### Usage of *sysconf-etc.d*

#### ```sysconf-etc.d help```

Print the list of available commands. Running ```sysconf-etc.d```
(with no argument) works as well.

#### ```sysconf-etc.d list```

Print the list of configuration files which are declared as *managed*
by a definition in a ```/etc/sysconf/etc.d/xx.meta.conf``` file.

Usage example:
```
# sysconf-etc.d list
sysconf-etc.d: gitconfig: /etc/sysconf/etc.d/gitconfig.meta.conf
sysconf-etc.d: hosts: /etc/sysconf/etc.d/hosts.meta.conf
sysconf-etc.d: mongodb: /etc/sysconf/etc.d/mongodb.meta.conf
sysconf-etc.d: ssh_config: /etc/sysconf/etc.d/ssh_config.meta.conf
sysconf-etc.d: sshd_config: /etc/sysconf/etc.d/sshd_config.meta.conf
```

#### ```sysconf-etc.d status <name>```

Print details about how *&lt;name&gt;*'s target is to be generated.
*&lt;name&gt;* is not a path, but a name, that correspond to the meta conf
```/etc/sysconf/etc.d/<name>.meta.conf``` .

If *&lt;name&gt;* is omitted, all names are shown.

#### ```sysconf-etc.d update <name>```

Generate/update the target file for *&lt;name&gt;*.
*&lt;name&gt;* is not a path, but a name, that correspond to the meta conf
```/etc/sysconf/etc.d/<name>.meta.conf``` .

If *&lt;name&gt;* is omitted, all names are processed.

### Format of ```.meta.conf``` files

A meta file is stored at ```/etc/sysconf/etc.d/<name>.meta.conf```
where *&lt;name&gt;* represents the config *name* to be used with the
[sysconf-etc.d](../../../usr/bin/sysconf-etc.d) command.

The general syntax is actually that of *bash(1)* shell. The file
does not need execution permissions as it is sourced by
*sysconf-etc.d*.

A meta-file is declarative: it needs to declare shell variable that
tells *sysconf-etc.d* how to generate the target config file.

Comments begin with a hash character (#). Any valid shell instruction
is allowed, if you ever need to make dynamic processing.

There are **2 mandatory variables**:
* ```SYSCONF_ETC_CONFIG_TARGET_CONF```: absolute path of target config
  file that needs to be generated/updated
* ```SYSCONF_ETC_CONFIG_TYPE```: indicates what method that is used to
  generate the target file: ```concatenation``` or ```reference```.
  
Optional variables:
* ```SYSCONF_ETC_CONFIG_EXT```: mandatory extension for individual
  config files that are taken to build the target file.
  Defaults to ```$(basename $SYSCONF_ETC_CONFIG_TARGET_CONF)```, which
  means that for a ```/etc/hosts``` target, only
  ```/etc/hosts.d/*.hosts``` are taken, other files in
  ```/etc/hosts.d/``` being silently ignored.


#### ```SYSCONF_ETC_CONFIG_TYPE=concatenation```
Example taken from [hosts.meta.conf](hosts.meta.conf):
```
SYSCONF_ETC_CONFIG_TARGET_CONF=/etc/hosts
SYSCONF_ETC_CONFIG_TYPE=concatenation
```

#### ```SYSCONF_ETC_CONFIG_TYPE=reference```
Example taken from [gitconfig.meta.conf](gitconfig.meta.conf):
```
SYSCONF_ETC_CONFIG_TARGET_CONF=/etc/gitconfig
SYSCONF_ETC_CONFIG_TYPE=reference
SYSCONF_ETC_CONFIG_EXT=conf
SYSCONF_ETC_CONFIG_BEGIN="[include]"
SYSCONF_ETC_CONFIG_EXPRESSION=" path = %p"
```

The ```reference``` type generates a list of explicit include
directives, by writing a ```$SYSCONF_ETC_CONFIG_BEGIN``` line followed
by include directives as defined by
```SYSCONF_ETC_CONFIG_EXPRESSION``` .

Variables specific to the ```reference``` type:
* ```SYSCONF_ETC_CONFIG_BEGIN```: a line that will be generated before
the list of references. For example, Git configuration requires that
*include* directives be listed in a ```[include]``` section. Defaults
to the empty string.

* ```SYSCONF_ETC_CONFIG_EXPRESSION``` (mandatory):format of an
  individual include/reference directive. The special token ```%p```
  is replaced with the absolute path of the referred file.

#### Hooks

Hooks are bash function that can be defined by a meta conf file.

There is only one hook available:
**SYSCONF_ETC_CONFIG_ONCHANGE_HOOK**, which is executed after the
target config file has been updated.

It is the right place to restart a service. Example:
```
# In /etc/sysconf/etc.d/postgresql.meta.conf

SYSCONF_ETC_CONFIG_ONCHANGE_HOOK() {
    service postgresql restart
}
```
